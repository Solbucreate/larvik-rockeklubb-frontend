<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>QR Billettskanner</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      margin: 0;
      text-align: center;
    }
    h1 {
      margin-top: 20px;
    }
    #eventSelect {
      margin-top: 15px;
      padding: 10px;
      font-size: 18px;
      border-radius: 6px;
    }
    #reader {
      width: 90%;
      max-width: 400px;
      margin: 20px auto;
      border: 2px solid #333;
      border-radius: 10px;
    }
    #resultBox {
      margin-top: 20px;
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 10px;
      display: inline-block;
      min-width: 260px;
    }
    .success {
      background: #0a0;
      color: black;
    }
    .error {
      background: #a00;
      color: white;
    }
  </style>

  <!-- QR code kamerabibliotek -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

  <h1>ðŸŽ« QR-Billettskanner</h1>

  <h3>Velg arrangement:</h3>
  <select id="eventSelect">
    <option>Henter arrangementer ...</option>
  </select>

  <div id="reader"></div>

  <div id="resultBox">Ingen scanning endaâ€¦</div>

  <script>
    const API = "https://larvik-rockeklubb-backend.onrender.com/api";


    // 1. Hent events
    async function loadEvents() {
      try {
        const res = await fetch(API + "/events");
        const events = await res.json();

        const dropdown = document.getElementById("eventSelect");
        dropdown.innerHTML = "";

        events.forEach(evt => {
          const opt = document.createElement("option");
          opt.value = evt.id;
          opt.textContent = `${evt.title} â€“ ${evt.date}`;
          dropdown.appendChild(opt);
        });

      } catch (err) {
        alert("Kunne ikke laste events");
      }
    }

    loadEvents();

    // 2. Resultatboks
    function showResult(msg, ok = false) {
      const box = document.getElementById("resultBox");
      box.textContent = msg;
      box.className = ok ? "success" : "error";

      if (ok && navigator.vibrate) navigator.vibrate(150);
    }

    // 3. Start QR scanner
    function startScanner() {
      const qr = new Html5Qrcode("reader");

      qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },

        async (decodedText) => {
  const raw = String(decodedText || "").trim();

  let eventIdToSend = Number(
    document.getElementById("eventSelect").value
  );
  let ticketCodeToSend = raw;

  // For QR-format: LR-<eventId>-<ticketCode>
  if (raw.startsWith("LR-")) {
    const parts = raw.split("-");
    const maybeEventId = Number(parts[1]);

    if (!Number.isNaN(maybeEventId) && parts.length >= 3) {
      eventIdToSend = maybeEventId;
      ticketCodeToSend = parts.slice(2).join("-");
    }
  }

  try {
    const res = await fetch(API + "/tickets/validate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        qr: ticketCodeToSend,
        eventId: eventIdToSend
      })
    });

    const data = await res.json();

    if (data.success) {
      showResult(`âœ” Gyldig billett: ${data.name}`, true);
    } else {
      showResult(`âœ– ${data.error}`, false);
    }
  } catch (err) {
    showResult("Feil ved validering!", false);
  }
}


    ,startScanner);}
  </script>

</body>
</html>
