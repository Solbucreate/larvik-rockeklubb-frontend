<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billettskanner â€“ Vakter</title>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
body {
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  margin: 0;
  padding: 20px;
}

#reader {
  width: 320px;
  margin: 20px auto;
}

select {
  padding: 10px;
  margin: 10px;
  font-size: 1.2rem;
  border-radius: 6px;
}

#status {
  font-size: 1.4rem;
  padding: 15px;
  border-radius: 10px;
  margin-top: 20px;
}

.ok {
  background: #0f0;
  color: #000;
}

.bad {
  background: #f00;
  color: #fff;
}
</style>
</head>

<body>

<h1>Billettskanner</h1>

<p>Velg arrangement:</p>

<select id="eventSelect">
  <option value="">Velg event</option>
</select>

<div id="reader"></div>
<div id="status">Velg event for Ã¥ starteâ€¦</div>

<script>
const API_URL = "http://localhost:3001/api/tickets/validate";

// ðŸ”¥ HENT EVENTS AUTOMATISK FRA BACKEND
async function loadEvents() {
  const select = document.getElementById("eventSelect");

  const res = await fetch("http://localhost:3001/api/events");
  const events = await res.json();

  events.forEach(ev => {
    const opt = document.createElement("option");
    opt.value = ev.id;
    opt.innerText = `${ev.title} (${ev.date})`;
    select.appendChild(opt);
  });
}

loadEvents();

function showStatus(msg, type) {
  const el = document.getElementById("status");
  el.className = type;
  el.innerText = msg;

  if (navigator.vibrate) {
    navigator.vibrate(type === "ok" ? 200 : 400);
  }
}

async function handleScan(data) {
  const eventId = document.getElementById("eventSelect").value;

  if (!eventId) {
    showStatus("Velg et arrangement fÃ¸rst!", "bad");
    return;
  }

  showStatus("Validerer billettâ€¦", "");

  const res = await fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ qr: data, eventId })
  });

  const result = await res.json();

  if (res.ok) {
    showStatus("âœ” Gyldig billett: " + result.name, "ok");
  } else {
    showStatus("âœ– Ugyldig: " + result.error, "bad");
  }
}

// Start QR scanner
let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
scanner.render(handleScan);

</script>

</body>
</html>
